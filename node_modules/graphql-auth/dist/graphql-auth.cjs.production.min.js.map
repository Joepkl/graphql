{"version":3,"file":"graphql-auth.cjs.production.min.js","sources":["../src/index.ts"],"sourcesContent":["type Resolver = (parent: any, params: any, context: any, info: any) => any;\n\nfunction validateScope(required: string[], provided: string[]): boolean {\n  let hasScope = false;\n\n  required.forEach((scope: string) => {\n    provided.forEach(function(providedScope: string) {\n      // user:* -> user:create, user:view:self\n      var regex = new RegExp('^' + providedScope.replace('*', '.*') + '$');\n      if (regex.exec(scope)) {\n        hasScope = true;\n      }\n    });\n  });\n\n  return hasScope;\n}\n\nexport default function withAuth(scope: any, callback?: any) {\n  const next: Resolver = callback ? callback : scope;\n\n  return async function(_: any, __: any, context: any, info: any) {\n    // will hold resolved scope, if any\n    let finalScope;\n\n    // if no auth object on context in resolver, error out\n    if (!context.auth) {\n      return new Error('`auth` property not found on context!');\n    }\n\n    // if user is not authenticated, error out\n    if (!context.auth.isAuthenticated) {\n      return new Error('Not authenticated!');\n    }\n\n    // determine if we need to check scopes\n    const hasScope = !!callback;\n    if (hasScope) {\n      // check if scope is a function that resolves to required scopes\n      if (typeof scope === 'function') {\n        // we wrap the function in a promise so whether scope resolver is async or not we can handle it like it is\n        finalScope = await Promise.resolve(() => scope(_, __, context, info));\n      } else {\n        finalScope = scope;\n      }\n\n      if (finalScope && finalScope.length) {\n        if (\n          !context.auth.scope ||\n          !validateScope(finalScope, context.auth.scope)\n        ) {\n          return new Error('Permission denied!');\n        }\n      }\n    }\n\n    return next(_, __, context, info);\n  };\n}\n"],"names":["scope","callback","next","_","__","context","info","finalScope","auth","Error","isAuthenticated","hasScope","length","required","provided","forEach","providedScope","RegExp","replace","exec","validateScope","Promise","resolve"],"mappings":"6FAkBiCA,EAAYC,OACrCC,EAAiBD,GAAsBD,kBAEvBG,EAAQC,EAASC,EAAcC,WAE/CC,2BAiCGL,EAAKC,EAAGC,EAAIC,EAASC,aA9BvBD,EAAQG,4BACJ,IAAIC,MAAM,8CAIdJ,EAAQG,KAAKE,uCACT,IAAID,MAAM,2BAIbE,IAAaV,kBACfU,uBASEJ,GAAcA,EAAWK,UAExBP,EAAQG,KAAKR,QA9CxB,SAAuBa,EAAoBC,OACrCH,GAAW,SAEfE,EAASE,SAAQ,SAACf,GAChBc,EAASC,SAAQ,SAASC,GAEZ,IAAIC,OAAO,IAAMD,EAAcE,QAAQ,IAAK,MAAQ,KACtDC,KAAKnB,KACbW,GAAW,SAKVA,EAkCES,CAAcb,EAAYF,EAAQG,KAAKR,oBAEjC,IAAIS,MAAM,uCAZA,mBAAVT,yBAEUqB,QAAQC,SAAQ,kBAAMtB,EAAMG,EAAGC,EAAIC,EAASC,yBAA/DC,OAEAA,EAAaP"}